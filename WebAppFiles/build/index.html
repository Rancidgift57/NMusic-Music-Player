<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NMusic Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- PWA Manifest (Embedded) -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1DB954">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .bg-custom-gray { background-color: #121212; }
        .bg-custom-light-gray { background-color: #181818; }
        .bg-custom-card { background-color: #282828; }
        .text-custom-gray { color: #b3b3b3; }

        .list-scrollbar::-webkit-scrollbar { width: 6px; }
        .list-scrollbar::-webkit-scrollbar-track { background: #181818; }
        .list-scrollbar::-webkit-scrollbar-thumb { background: #535353; border-radius: 3px; }
        .list-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b6b6b; }
        
        .sortable-ghost { background: #3a3a3a; opacity: 0.5; border-radius: 0.5rem; }
        .sortable-chosen { background: #3a3a3a; border-radius: 0.5rem; }

        .modal-content { transition: transform 0.3s ease-out; }
    </style>
</head>
<body class="bg-custom-gray text-white antialiased overflow-hidden">

    <div class="container mx-auto max-w-md h-screen flex flex-col p-4 space-y-4 bg-custom-light-gray">

        <div id="api-status" class="text-center text-red-400 text-sm p-2 rounded-lg bg-red-500/10 hidden"></div>

        <div class="flex-grow flex flex-col justify-center bg-custom-card p-6 rounded-xl shadow-lg space-y-4">
            <div class="text-center">
                <h2 class="text-sm text-custom-gray uppercase tracking-wider">Now Playing</h2>
                <p id="now-playing-song" class="text-xl font-bold truncate">No Song Selected</p>
            </div>
            
            <div id="album-art-container" class="aspect-square bg-gray-700 rounded-lg shadow-md overflow-hidden">
                 <img id="album-art-img" 
                     src="https://images.unsplash.com/photo-1511379938547-c1f69419868d?q=80&w=512&auto=format&fit=crop" 
                     onerror="this.onerror=null;this.src='https://placehold.co/512x512/282828/b3b3b3?text=NMusic';"
                     alt="Album Art" 
                     class="w-full h-full object-cover">
            </div>

            <div>
                <div id="progress-bar-container" class="bg-gray-600 rounded-full h-1.5 cursor-pointer">
                    <div id="progress-bar" class="bg-green-500 h-1.5 rounded-full w-0"></div>
                </div>
                <div class="flex justify-between text-xs text-custom-gray mt-1">
                    <span id="current-time">0:00</span>
                    <span id="total-time">0:00</span>
                </div>
            </div>

            <div class="flex justify-around items-center">
                <button id="playlist-toggle-btn" class="text-2xl text-custom-gray hover:text-white transition-colors"><i class="fas fa-guitar"></i></button>
                <button id="prev-btn" class="text-2xl text-custom-gray hover:text-white transition-colors"><i class="fas fa-backward-step"></i></button>
                <button id="play-pause-btn" class="bg-green-500 text-black w-16 h-16 rounded-full flex items-center justify-center text-3xl shadow-lg transform hover:scale-105 transition-transform">
                    <i id="play-pause-icon" class="fas fa-play"></i>
                </button>
                <button id="next-btn" class="text-2xl text-custom-gray hover:text-white transition-colors"><i class="fas fa-forward-step"></i></button>
                <button id="queue-toggle-btn" class="text-2xl text-custom-gray hover:text-white transition-colors"><i class="fas fa-list-ul"></i></button>
            </div>
        </div>
        
        <div class="flex-shrink-0">
            <form id="add-song-form" class="flex space-x-2">
                <input type="text" id="song-name-input" class="flex-grow bg-custom-card border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Enter a song name to add" required>
                <button type="submit" class="bg-green-500 text-black font-bold px-4 py-2 rounded-lg hover:bg-green-600 transition-colors"><i class="fas fa-plus"></i> Add</button>
            </form>
        </div>
    </div>

    <!-- Queue Modal -->
    <div id="queue-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-end justify-center hidden z-50">
        <div id="queue-modal-content" class="modal-content bg-custom-card w-full max-w-md h-3/4 rounded-t-2xl flex flex-col transform translate-y-full">
             <div class="p-4 flex justify-between items-center border-b border-gray-700 flex-shrink-0">
                <h3 class="font-semibold text-lg">Up Next</h3>
                <div>
                    <button id="clear-queue-btn" class="text-sm text-custom-gray hover:text-red-500 transition-colors mr-4">Clear All</button>
                    <button id="close-queue-btn" class="text-xl text-custom-gray hover:text-white"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="queue-list" class="list-scrollbar flex-grow overflow-y-auto p-2 space-y-2">
                <div id="empty-queue-message" class="text-center text-custom-gray p-8">Your queue is empty.</div>
            </div>
        </div>
    </div>
    
    <!-- Playlist Modal -->
    <div id="playlist-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-end justify-center hidden z-50">
        <div id="playlist-modal-content" class="modal-content bg-custom-card w-full max-w-md h-3/4 rounded-t-2xl flex flex-col transform translate-y-full">
             <div class="p-4 flex justify-between items-center border-b border-gray-700 flex-shrink-0">
                <h3 class="font-semibold text-lg">Playlist</h3>
                <button id="close-playlist-btn" class="text-xl text-custom-gray hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div id="playlist-list" class="list-scrollbar flex-grow overflow-y-auto p-2 space-y-2">
                <div id="empty-playlist-message" class="text-center text-custom-gray p-8">Loading playlist...</div>
            </div>
        </div>
    </div>

    <audio id="audio-player" class="hidden"></audio>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE_URL = 'https://nmusic.onrender.com';

            // --- DOM Elements ---
            const apiStatusEl = document.getElementById('api-status');
            const audioPlayer = document.getElementById('audio-player');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const playPauseIcon = document.getElementById('play-pause-icon');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const progressBar = document.getElementById('progress-bar');
            const progressBarContainer = document.getElementById('progress-bar-container');
            const currentTimeEl = document.getElementById('current-time');
            const totalTimeEl = document.getElementById('total-time');
            const nowPlayingSongEl = document.getElementById('now-playing-song');
            const addSongForm = document.getElementById('add-song-form');
            const songNameInput = document.getElementById('song-name-input');
            
            const queueModal = document.getElementById('queue-modal');
            const queueModalContent = document.getElementById('queue-modal-content');
            const queueToggleBtn = document.getElementById('queue-toggle-btn');
            const closeQueueBtn = document.getElementById('close-queue-btn');
            const queueListEl = document.getElementById('queue-list');
            const emptyQueueMessage = document.getElementById('empty-queue-message');
            const clearQueueBtn = document.getElementById('clear-queue-btn');

            const playlistModal = document.getElementById('playlist-modal');
            const playlistModalContent = document.getElementById('playlist-modal-content');
            const playlistToggleBtn = document.getElementById('playlist-toggle-btn');
            const closePlaylistBtn = document.getElementById('close-playlist-btn');
            const playlistListEl = document.getElementById('playlist-list');
            const emptyPlaylistMessage = document.getElementById('empty-playlist-message');

            // --- State ---
            let currentQueue = [];
            let currentPlaylist = [];
            let currentSongIndex = -1;
            let isPlaying = false;
            let isPlayingFromPlaylist = false; // New state to track playback source
            let sortableQueueInstance = null;
            let sortablePlaylistInstance = null;

            // --- API Functions ---
            const api = {
                getQueue: async () => {
                    try {
                        const response = await fetch(`${API_BASE_URL}/queue`);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        apiStatusEl.classList.add('hidden');
                        return await response.json();
                    } catch (error) {
                        console.error('Failed to get queue:', error);
                        apiStatusEl.textContent = 'API Connection Error. Server may be asleep or offline.';
                        apiStatusEl.classList.remove('hidden');
                        return { queue: [] };
                    }
                },
                getPlaylist: async () => {
                    try {
                        const response = await fetch(`${API_BASE_URL}/playlist`);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return await response.json();
                    } catch (error) {
                        console.error('Failed to get playlist:', error);
                        playlistListEl.innerHTML = `<div class="text-center text-custom-gray p-8">Could not load playlist.</div>`;
                        return { songs: [] };
                    }
                },
                addSong: async (songName) => {
                    try {
                        const response = await fetch(`${API_BASE_URL}/queue/add`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name: songName })
                        });
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return await response.json();
                    } catch (error) { console.error('Failed to add song:', error); }
                },
                removeSong: async (songId) => {
                     try {
                        const response = await fetch(`${API_BASE_URL}/queue/${songId}`, { method: 'DELETE' });
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return await response.json();
                    } catch (error) { console.error('Failed to remove song:', error); }
                },
                clearQueue: async () => {
                    try {
                        const response = await fetch(`${API_BASE_URL}/queue/clear`, { method: 'POST' });
                         if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return await response.json();
                    } catch (error) { console.error('Failed to clear queue:', error); }
                },
                reorderQueue: async (orderedIds) => {
                    try {
                        const response = await fetch(`${API_BASE_URL}/queue/reorder`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ order: orderedIds })
                        });
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return await response.json();
                    } catch (error) { console.error('Failed to reorder queue:', error); }
                }
            };

            // --- UI Rendering ---
            const renderQueue = () => {
                queueListEl.innerHTML = '';
                if (currentQueue.length === 0) {
                    emptyQueueMessage.classList.remove('hidden');
                } else {
                    emptyQueueMessage.classList.add('hidden');
                    currentQueue.forEach((song, index) => {
                        const isCurrentSong = index === currentSongIndex && !isPlayingFromPlaylist;
                        const li = document.createElement('div');
                        li.className = `flex items-center p-3 rounded-lg transition-colors cursor-grab ${isCurrentSong ? 'bg-green-500/20' : 'hover:bg-gray-700'}`;
                        li.dataset.songId = song.id;
                        li.dataset.songName = song.name;
                        li.dataset.index = index;
                        li.innerHTML = `
                            <div class="flex-grow flex items-center space-x-3 play-song-trigger">
                                ${isCurrentSong && isPlaying ? '<i class="fas fa-volume-up text-green-400"></i>' : '<i class="fas fa-music text-custom-gray"></i>'}
                                <span class="font-medium truncate">${song.name}</span>
                            </div>
                            <button class="remove-song-btn text-custom-gray hover:text-red-500 text-sm" data-song-id="${song.id}"><i class="fas fa-trash"></i></button>`;
                        queueListEl.appendChild(li);
                    });
                }
                document.querySelectorAll('.play-song-trigger').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const songElement = e.currentTarget.closest('[data-index]');
                        if (songElement) playFromQueueByIndex(parseInt(songElement.dataset.index, 10));
                    });
                });
                document.querySelectorAll('.remove-song-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleRemoveSong(btn.dataset.songId);
                    });
                });
            };

            const renderPlaylist = () => {
                playlistListEl.innerHTML = '';
                if (currentPlaylist.length === 0) {
                    emptyPlaylistMessage.textContent = 'Playlist is empty.';
                } else {
                    emptyPlaylistMessage.classList.add('hidden');
                    currentPlaylist.forEach((song, index) => {
                        const isCurrentSong = index === currentSongIndex && isPlayingFromPlaylist;
                        const li = document.createElement('div');
                        li.className = `flex items-center p-3 rounded-lg transition-colors cursor-grab ${isCurrentSong ? 'bg-green-500/20' : 'hover:bg-gray-700'}`;
                        li.dataset.songName = song.name;
                        li.dataset.index = index;
                        li.innerHTML = `
                            <div class="flex-grow flex items-center space-x-3 play-from-playlist-trigger">
                                ${isCurrentSong && isPlaying ? '<i class="fas fa-volume-up text-green-400"></i>' : '<i class="fas fa-guitar text-custom-gray"></i>'}
                                <span class="font-medium truncate">${song.name}</span>
                            </div>`;
                        playlistListEl.appendChild(li);
                    });
                }
                document.querySelectorAll('.play-from-playlist-trigger').forEach(trigger => {
                    trigger.addEventListener('click', (e) => {
                        const songElement = e.currentTarget.closest('[data-index]');
                        if (songElement) playFromPlaylistByIndex(parseInt(songElement.dataset.index, 10));
                    });
                });
            };

            const updateNowPlayingUI = (songName) => { nowPlayingSongEl.textContent = songName || 'No Song Selected'; };
            const formatTime = (seconds) => {
                if (isNaN(seconds)) return '0:00';
                const minutes = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
            };

            // --- Player Logic ---
            const playFromQueueByIndex = (index) => {
                if (index < 0 || index >= currentQueue.length) return;
                isPlayingFromPlaylist = false;
                currentSongIndex = index;
                const song = currentQueue[index];
                audioPlayer.src = `${API_BASE_URL}/play/${encodeURIComponent(song.name)}`;
                audioPlayer.play();
                updateNowPlayingUI(song.name);
            };

            const playFromPlaylistByIndex = (index) => {
                if (index < 0 || index >= currentPlaylist.length) return;
                isPlayingFromPlaylist = true;
                currentSongIndex = index;
                const song = currentPlaylist[index];
                audioPlayer.src = `${API_BASE_URL}/play/${encodeURIComponent(song.name)}`;
                audioPlayer.play();
                updateNowPlayingUI(song.name);
            };

            const togglePlayPause = () => {
                if (currentSongIndex === -1) {
                    if (isPlayingFromPlaylist && currentPlaylist.length > 0) playFromPlaylistByIndex(0);
                    else if (!isPlayingFromPlaylist && currentQueue.length > 0) playFromQueueByIndex(0);
                    return;
                }
                if (audioPlayer.src) isPlaying ? audioPlayer.pause() : audioPlayer.play();
            };
            
            const playNext = () => {
                if (isPlayingFromPlaylist) {
                    if (currentPlaylist.length === 0) return;
                    let nextIndex = currentSongIndex + 1;
                    if (nextIndex >= currentPlaylist.length) nextIndex = 0;
                    playFromPlaylistByIndex(nextIndex);
                } else {
                    if (currentQueue.length === 0) return;
                    let nextIndex = currentSongIndex + 1;
                    if (nextIndex >= currentQueue.length) nextIndex = 0;
                    playFromQueueByIndex(nextIndex);
                }
            };
            
            const playPrev = () => {
                if (isPlayingFromPlaylist) {
                    if (currentPlaylist.length === 0) return;
                    let prevIndex = currentSongIndex - 1;
                    if (prevIndex < 0) prevIndex = currentPlaylist.length - 1;
                    playFromPlaylistByIndex(prevIndex);
                } else {
                    if (currentQueue.length === 0) return;
                    let prevIndex = currentSongIndex - 1;
                    if (prevIndex < 0) prevIndex = currentQueue.length - 1;
                    playFromQueueByIndex(prevIndex);
                }
            };

            // --- Event Handlers ---
            const handleAddSong = async (e) => {
                e.preventDefault();
                const songName = songNameInput.value.trim();
                if (songName) {
                    await api.addSong(songName);
                    songNameInput.value = '';
                    await refreshQueue();
                }
            };

            const handleRemoveSong = async (songId) => {
                const songIndex = currentQueue.findIndex(s => s.id === songId);
                await api.removeSong(songId);
                await refreshQueue();
                if (!isPlayingFromPlaylist && songIndex === currentSongIndex) {
                    if (currentQueue.length > 0) {
                        playFromQueueByIndex(currentSongIndex % currentQueue.length);
                    } else {
                        audioPlayer.pause();
                        audioPlayer.src = '';
                        updateNowPlayingUI(null);
                    }
                }
            };
            
            const handleClearQueue = async () => {
                await api.clearQueue();
                if (!isPlayingFromPlaylist) {
                    audioPlayer.pause();
                    audioPlayer.src = '';
                    updateNowPlayingUI(null);
                }
                await refreshQueue();
            };
            
            // --- Modal Logic ---
            const openModal = (modal, content) => {
                modal.classList.remove('hidden');
                requestAnimationFrame(() => content.classList.remove('translate-y-full'));
            };
            const closeModal = (modal, content) => {
                content.classList.add('translate-y-full');
                setTimeout(() => modal.classList.add('hidden'), 300);
            };
            const openQueueModal = () => openModal(queueModal, queueModalContent);
            const closeQueueModal = () => closeModal(queueModal, queueModalContent);
            const openPlaylistModal = () => openModal(playlistModal, playlistModalContent);
            const closePlaylistModal = () => closeModal(playlistModal, playlistModalContent);

            // --- Initialization ---
            const refreshQueue = async () => {
                const queueData = await api.getQueue();
                currentQueue = queueData.queue || [];
                renderQueue();
            };

            const loadPlaylist = async () => {
                const playlistData = await api.getPlaylist();
                currentPlaylist = playlistData.songs || [];
                renderPlaylist();
            };
            
            const initSortable = () => {
                if (sortableQueueInstance) sortableQueueInstance.destroy();
                sortableQueueInstance = new Sortable(queueListEl, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    onEnd: async (evt) => {
                        const orderedIds = Array.from(queueListEl.children).map(child => child.dataset.songId);
                        await api.reorderQueue(orderedIds);
                        await refreshQueue();
                    },
                });

                if (sortablePlaylistInstance) sortablePlaylistInstance.destroy();
                sortablePlaylistInstance = new Sortable(playlistListEl, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    onEnd: (evt) => {
                        const reorderedPlaylist = [];
                        playlistListEl.querySelectorAll('[data-song-name]').forEach(el => {
                            const song = currentPlaylist.find(s => s.name === el.dataset.songName);
                            if(song) reorderedPlaylist.push(song);
                        });
                        currentPlaylist = reorderedPlaylist;
                        renderPlaylist(); // Re-render to update indices
                    },
                });
            };

            const init = async () => {
                audioPlayer.addEventListener('play', () => { isPlaying = true; playPauseIcon.className = 'fas fa-pause'; isPlayingFromPlaylist ? renderPlaylist() : renderQueue(); });
                audioPlayer.addEventListener('pause', () => { isPlaying = false; playPauseIcon.className = 'fas fa-play'; isPlayingFromPlaylist ? renderPlaylist() : renderQueue(); });
                audioPlayer.addEventListener('ended', playNext);
                audioPlayer.addEventListener('timeupdate', () => {
                    if (audioPlayer.duration) {
                        progressBar.style.width = `${(audioPlayer.currentTime / audioPlayer.duration) * 100}%`;
                        currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
                    }
                });
                audioPlayer.addEventListener('loadedmetadata', () => { totalTimeEl.textContent = formatTime(audioPlayer.duration); });
                
                playPauseBtn.addEventListener('click', togglePlayPause);
                nextBtn.addEventListener('click', playNext);
                prevBtn.addEventListener('click', playPrev);
                addSongForm.addEventListener('submit', handleAddSong);
                clearQueueBtn.addEventListener('click', handleClearQueue);
                
                queueToggleBtn.addEventListener('click', openQueueModal);
                closeQueueBtn.addEventListener('click', closeQueueModal);
                queueModal.addEventListener('click', (e) => { if (e.target === queueModal) closeQueueModal(); });
                
                playlistToggleBtn.addEventListener('click', openPlaylistModal);
                closePlaylistBtn.addEventListener('click', closePlaylistModal);
                playlistModal.addEventListener('click', (e) => { if (e.target === playlistModal) closePlaylistModal(); });

                progressBarContainer.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (audioPlayer.duration) {
                        const rect = progressBarContainer.getBoundingClientRect();
                        audioPlayer.currentTime = (e.clientX - rect.left) / rect.width * audioPlayer.duration;
                    }
                });

                await Promise.all([refreshQueue(), loadPlaylist()]);
                initSortable();
            };

            init();
        });
    </script>
    
    <script>
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('ServiceWorker registration successful with scope: ', registration.scope))
                    .catch(error => console.log('ServiceWorker registration failed: ', error));
            });
        }
    </script>
</body>
</html>
